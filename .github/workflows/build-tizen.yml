name: Build Kodi for Tizen

on:
  push:
    branches: [ main, master ]
    paths:
      - 'xbmc/**'
      - 'cmake/**'
      - 'tools/depends/**'
      - 'CMakeLists.txt'
      - '.github/workflows/build-tizen.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  build-tizen:
    name: Build Tizen TPK
    runs-on: ubuntu-22.04  # Use 22.04 for better availability and performance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version info
      
      - name: Free up disk space
        run: |
          # Remove unnecessary packages to free up space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            curl \
            git \
            python3 \
            python3-pip \
            autoconf \
            automake \
            libtool \
            pkg-config \
            gawk \
            gperf \
            zip \
            unzip \
            wget \
            default-jre \
            nasm \
            yasm \
            libssl-dev
      
      - name: Cache Tizen SDK
        id: cache-tizen-sdk
        uses: actions/cache@v4
        with:
          path: ~/tizen-studio
          key: tizen-sdk-5.0-${{ runner.os }}
      
      - name: Download and install Tizen SDK
        if: steps.cache-tizen-sdk.outputs.cache-hit != 'true'
        run: |
          cd /tmp
          wget http://download.tizen.org/sdk/Installer/tizen-studio_5.0/web-cli_Tizen_Studio_5.0_ubuntu-64.bin
          chmod +x web-cli_Tizen_Studio_5.0_ubuntu-64.bin
          ./web-cli_Tizen_Studio_5.0_ubuntu-64.bin --accept-license $HOME/tizen-studio
      
      - name: Install Tizen packages
        run: |
          $HOME/tizen-studio/package-manager/package-manager-cli.bin install \
            NativeToolchain-Gcc-9.2 \
            PLATFORM-6.0-NativeAppDevelopment-CLI || true
          # Verify toolchain is installed
          ls -la $HOME/tizen-studio/tools/arm-linux-gnueabi-gcc-9.2/bin/ || echo "Toolchain not found"
      
      - name: Cache Kodi dependencies
        id: cache-kodi-deps
        uses: actions/cache@v4
        with:
          path: ~/kodi-tizen-deps
          key: kodi-deps-${{ hashFiles('tools/depends/**') }}
          restore-keys: |
            kodi-deps-
      
      - name: Patch for C++17 compatibility
        run: |
          # Patch configure.ac to use C++17 instead of C++20 for GCC 9.2 compatibility
          sed -i 's/AX_CXX_COMPILE_STDCXX(\[20\]/AX_CXX_COMPILE_STDCXX([17]/' tools/depends/configure.ac
          # Patch CMake to use C++17
          sed -i 's/CMAKE_CXX_STANDARD 20/CMAKE_CXX_STANDARD 17/' cmake/scripts/common/CompilerSettings.cmake
          # Verify patches
          grep "AX_CXX_COMPILE_STDCXX" tools/depends/configure.ac
          grep "CMAKE_CXX_STANDARD" cmake/scripts/common/CompilerSettings.cmake
      
      - name: Build Kodi dependencies
        if: steps.cache-kodi-deps.outputs.cache-hit != 'true'
        run: |
          export PATH=$HOME/tizen-studio/tools/arm-linux-gnueabi-gcc-9.2/bin:$PATH
          export TIZEN_SDK=$HOME/tizen-studio
          export CC=$HOME/tizen-studio/tools/arm-linux-gnueabi-gcc-9.2/bin/arm-linux-gnueabi-gcc
          export CXX=$HOME/tizen-studio/tools/arm-linux-gnueabi-gcc-9.2/bin/arm-linux-gnueabi-g++
          export AR=$HOME/tizen-studio/tools/arm-linux-gnueabi-gcc-9.2/bin/arm-linux-gnueabi-ar
          export RANLIB=$HOME/tizen-studio/tools/arm-linux-gnueabi-gcc-9.2/bin/arm-linux-gnueabi-ranlib
          cd tools/depends
          ./bootstrap
          ./configure \
            --prefix=$HOME/kodi-tizen-deps \
            --host=arm-tizen-linux-gnueabi \
            --with-toolchain=$HOME/tizen-studio/tools/arm-linux-gnueabi-gcc-9.2 \
            --with-platform=tizen \
            --with-rendersystem=gles \
            --enable-debug=no \
            CC="$CC" \
            CXX="$CXX" \
            AR="$AR" \
            RANLIB="$RANLIB"
          make -j$(nproc)
      
      - name: Build Kodi
        run: |
          export PATH=$PATH:$HOME/tizen-studio/tools
          export TIZEN_SDK=$HOME/tizen-studio
          make -C tools/depends/target/cmakebuildsys
          cd build
          make -j$(nproc)
      
      - name: Create TPK package
        run: |
          cd build
          make tpk
          # List created files
          ls -lh *.tpk || echo "No TPK files found"
      
      - name: Get version info
        id: version
        run: |
          VERSION=$(grep "VERSION_MAJOR" version.txt | cut -d' ' -f2).$(grep "VERSION_MINOR" version.txt | cut -d' ' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Kodi version: $VERSION"
      
      - name: Upload TPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: kodi-tizen-${{ steps.version.outputs.version }}-arm
          path: build/*.tpk
          retention-days: 30
          if-no-files-found: error
      
      - name: Build summary
        run: |
          echo "## Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### TPK Files Created:" >> $GITHUB_STEP_SUMMARY
          ls -lh build/*.tpk >> $GITHUB_STEP_SUMMARY || echo "No TPK files found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Instructions:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Download the TPK from the Artifacts section above" >> $GITHUB_STEP_SUMMARY
          echo "# Then install on your Samsung TV:" >> $GITHUB_STEP_SUMMARY
          echo "sdb connect <TV_IP>:26101" >> $GITHUB_STEP_SUMMARY
          echo "sdb install kodi-tizen-*.tpk" >> $GITHUB_STEP_SUMMARY
          echo "sdb shell app_launcher -s org.xbmc.kodi" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
